import winreg
import os
import subprocess


def check_registry_key_recursive(root_key, subkey, target_name):
    path_list = []
    try:
        # 현재 폴더의 모든 하위 키를 열고 검사합니다.
        with winreg.OpenKey(root_key, subkey) as key:
            for i in range(winreg.QueryInfoKey(key)[0]):
                # 각 하위 키에 대해 재귀적으로 검사합니다.
                next_subkey = winreg.EnumKey(key, i)
                next_subkey_path = f"{subkey}\\{next_subkey}"
                if len(check_registry_key_recursive(root_key, next_subkey_path, target_name)) != 0:
                    path_list.extend(check_registry_key_recursive(root_key, next_subkey_path, target_name))

                # 현재 키의 값을 검사합니다.
                try:
                    registry_key = winreg.OpenKey(root_key, next_subkey_path, 0, winreg.KEY_READ)
                    value, _ = winreg.QueryValueEx(registry_key, target_name)
                    winreg.CloseKey(registry_key)
                    path_list.append(next_subkey_path)
                except FileNotFoundError:
                    pass  # 해당 키에 값이 없는 경우 무시합니다.
        return path_list
        
    except FileNotFoundError:
        return path_list
    
def get_LMregistry_value(registry_path, value_name):
    try:
        # registry key open
        registry_key = winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, registry_path, 0, winreg.KEY_READ)
        
        # read specific vale
        value_data, _ = winreg.QueryValueEx(registry_key, value_name)
        
        # registry key close
        winreg.CloseKey(registry_key)
        
        return value_data

    # Error
    except FileNotFoundError:
        print("The registry key or value does not exist.")
        return None
    except Exception as e:
        print("An error occurred: ", e)
        return None



if __name__ == "__main__":
    # window defenders
    registry_path = r'SOFTWARE\Policies\Microsoft\Windows Defender'
    # name of specific value
    value_name = 'DisableRealTimeMonitering'
    wd_vaccine_value = get_LMregistry_value(registry_path, value_name)
    print(f"[window defenders 백신 관련 레지스트리 이름] 값: {wd_vaccine_value}")
    
    # 알약
    #   최상위 폴더 탐색
    registry_path = r'SOFTWARE\ESTsoft'
    # name of specific value
    value_name = 'realtimeMonitorUse'
    al_vaccine_value = get_LMregistry_value(registry_path, value_name)
    print(f"[ALYac 백신 관련 레지스트리 이름] 값: {al_vaccine_value}")
    #   하위 폴더 탐색
    if al_vaccine_value == None:
        registry_paths = check_registry_key_recursive(winreg.HKEY_LOCAL_MACHINE, registry_path, value_name)
        
        if len(registry_paths) > 1:
            pass
        elif len(registry_paths) < 1:
            pass
        else:
            registry_path = registry_paths[0]
            # name of specific value
            al_vaccine_value = get_LMregistry_value(registry_path, value_name)
            print(f"[ALYac 백신 관련 레지스트리 이름] 값: {al_vaccine_value}")

    # v3
    registry_path = r'SOFTWARE\AhnLab\V3Lite4'
    # name of specific value
    value_name = 'sysmonuse'
    v3_vaccine_value = get_LMregistry_value(registry_path, value_name)
    print(f"[V3 백신 관련 레지스트리 이름] 값: {v3_vaccine_value}")
    #   하위 폴더 탐색
    if v3_vaccine_value == None:
        registry_paths = check_registry_key_recursive(winreg.HKEY_LOCAL_MACHINE, registry_path, value_name)

        if len(registry_paths) > 1:
            pass
        elif len(registry_paths) < 1:
            pass
        else:
            registry_path = registry_paths[0]
            # name of specific value
            v3_vaccine_value = get_LMregistry_value(registry_path, value_name)
            print(f"[V3 백신 관련 레지스트리 이름] 값: {v3_vaccine_value}")

    val = 0
    if wd_vaccine_value is not None:
        if wd_vaccine_value == 0:
            val = 1
            print("Window Defenders 실시간 감시 적용중입니다.")
        elif wd_vaccine_value == 1:
            print("Window Defenders 실시간 감시가 꺼져 있습니다.")
    else:
        print("window defenders 백신 관련 레지스트리 값을 읽을 수 없습니다.")

    if al_vaccine_value is not None:
        if al_vaccine_value == 1:
            val = 1
            print("ALYac 실시간 감시 적용중입니다.")
        elif al_vaccine_value == 0:
            print("ALYac 실시간 감시가 꺼져 있습니다.")
    else:
        print("ALYac 백신 관련 레지스트리 값을 읽을 수 없습니다.")

    if v3_vaccine_value is not None:
        if v3_vaccine_value == 1:
            val = 1
            print("V3 실시간 감시 적용중입니다.")
        elif v3_vaccine_value == 0:
            print("V3 실시간 감시가 꺼져 있습니다.")
    else:
        print("V3 백신 관련 레지스트리 값을 읽을 수 없습니다.")

    if val == 1:
        print("정상: 백신 프로그램의 실시간 감시가 감지됩니다.")
    elif val == 0:
        print("취약점 발견: 백신 프로그램의 실시간 감시가 감지되지 않습니다.")
    print("")
